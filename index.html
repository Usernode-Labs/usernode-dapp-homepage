<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Usernode dapps</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f7f8fb;
        --fg: #0b1220;
        --muted: #4b5568;
        --card: #ffffff;
        --border: rgba(15, 23, 42, 0.12);
        --accent: #2563eb;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b0f16;
          --fg: #e7edf7;
          --muted: #a8b3c7;
          --card: #141b26;
          --border: rgba(255, 255, 255, 0.12);
          --accent: #6ea8fe;
        }
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg);
        color: var(--fg);
        height: 100vh;
        height: 100dvh;
      }
      main {
        height: 100vh;
        height: 100dvh;
        display: flex;
        justify-content: flex-start;
        align-items: stretch;
        padding: 16px;
        box-sizing: border-box;
      }
      .card {
        width: 100%;
        max-width: 820px;
        margin: 0 auto;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100%;
        min-height: 0;
      }
      .header {
        padding: 18px 18px 12px;
        border-bottom: 1px solid var(--border);
        background: var(--card);
        flex: 0 0 auto;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .headerRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      h1 {
        margin: 0;
        font-size: 22px;
        letter-spacing: 0.2px;
      }
      p {
        margin: 10px 0;
        color: var(--muted);
        line-height: 1.45;
      }
      .sortWrap {
        position: relative;
        flex: 0 0 auto;
      }
      .sortBtn {
        appearance: none;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--muted);
        font-size: 13px;
        padding: 6px 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
        font-family: inherit;
      }
      .sortBtn:hover {
        color: var(--fg);
        border-color: var(--accent);
      }
      .sortBtn svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
      }
      .sortMenu {
        display: none;
        position: absolute;
        top: calc(100% + 4px);
        right: 0;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.18);
        z-index: 100;
        min-width: 180px;
        padding: 4px;
        overflow: hidden;
      }
      .sortMenu.open {
        display: block;
      }
      .sortOpt {
        display: block;
        width: 100%;
        padding: 8px 12px;
        border: none;
        background: transparent;
        color: var(--fg);
        font-size: 13px;
        text-align: left;
        cursor: pointer;
        border-radius: 6px;
        font-family: inherit;
      }
      .sortOpt:hover {
        background: var(--border);
      }
      .sortOpt.active {
        color: var(--accent);
        font-weight: 600;
      }
      ul {
        list-style: none;
        padding: 12px 12px 14px;
        margin: 0;
        display: grid;
        gap: 10px;
        will-change: transform;
        touch-action: none;
        flex: 1 1 auto;
        min-height: 0;
        align-content: start;
        grid-auto-rows: max-content;
      }
      li {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0;
        overflow: hidden;
      }
      .dappLink {
        display: grid;
        gap: 4px;
        padding: 12px 12px;
        color: inherit;
        text-decoration: none;
        touch-action: none;
      }
      .dappLink:hover {
        text-decoration: none;
      }
      .dappLink:active {
        filter: brightness(0.98);
      }
      .nameRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .name {
        font-weight: 600;
        min-width: 0;
      }
      .stats {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
        font-size: 13px;
        color: var(--muted);
      }
      .stat {
        display: flex;
        align-items: center;
        gap: 3px;
        white-space: nowrap;
      }
      .stat svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
        opacity: 0.7;
      }
      .statsLoading {
        font-size: 12px;
        color: var(--muted);
        opacity: 0.5;
      }
      .author {
        color: var(--muted);
        font-size: 13px;
      }
      .url {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.95em;
        word-break: break-word;
      }
      .urlText {
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <main>
      <div class="card">
        <div class="header">
          <div class="headerRow">
            <h1>Dapps</h1>
            <div class="sortWrap">
              <button class="sortBtn" id="sortBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M6 12h12M9 18h6"/></svg>
                <span id="sortLabel">Popular</span>
              </button>
              <div class="sortMenu" id="sortMenu">
                <button class="sortOpt" data-sort="popular">Popular</button>
                <button class="sortOpt" data-sort="users">Most users</button>
                <button class="sortOpt" data-sort="txns">Most transactions</button>
                <button class="sortOpt" data-sort="alpha">Alphabetical</button>
              </div>
            </div>
          </div>
        </div>
        <ul id="dappList"></ul>
      </div>
    </main>
    <script>
      const EXPLORER_BASE = window.location.origin + "/explorer-api";
      const SORT_KEY = "dapphome:sort";
      const PERSON_WEIGHT = 20;

      const list = document.getElementById("dappList");
      const sortBtn = document.getElementById("sortBtn");
      const sortMenu = document.getElementById("sortMenu");
      const sortLabel = document.getElementById("sortLabel");

      let allApps = [];
      let statsMap = {};
      let currentSort = localStorage.getItem(SORT_KEY) || "popular";

      const SORT_LABELS = {
        popular: "Popular",
        users: "Most users",
        txns: "Most transactions",
        alpha: "Alphabetical",
      };

      function clearList() {
        if (!list) return;
        list.textContent = "";
      }

      function addRow(text) {
        if (!list) return;
        const li = document.createElement("li");
        li.style.padding = "12px 12px";
        li.style.color = "var(--muted)";
        li.textContent = text;
        list.appendChild(li);
      }

      function personIcon() {
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", "0 0 24 24");
        svg.setAttribute("fill", "none");
        svg.setAttribute("stroke", "currentColor");
        svg.setAttribute("stroke-width", "2");
        svg.setAttribute("stroke-linecap", "round");
        svg.setAttribute("stroke-linejoin", "round");
        svg.innerHTML = '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>';
        return svg;
      }

      function txIcon() {
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", "0 0 24 24");
        svg.setAttribute("fill", "none");
        svg.setAttribute("stroke", "currentColor");
        svg.setAttribute("stroke-width", "2");
        svg.setAttribute("stroke-linecap", "round");
        svg.setAttribute("stroke-linejoin", "round");
        svg.innerHTML = '<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>';
        return svg;
      }

      function formatNum(n) {
        if (n >= 1000000) return (n / 1000000).toFixed(1).replace(/\.0$/, "") + "M";
        if (n >= 1000) return (n / 1000).toFixed(1).replace(/\.0$/, "") + "k";
        return String(n);
      }

      function sortApps(apps) {
        const sorted = apps.slice();
        sorted.sort((a, b) => {
          const sa = statsMap[a.pubkey] || { users: 0, txns: 0 };
          const sb = statsMap[b.pubkey] || { users: 0, txns: 0 };
          switch (currentSort) {
            case "alpha":
              return (a.name || "").localeCompare(b.name || "");
            case "users":
              return sb.users - sa.users || sb.txns - sa.txns;
            case "txns":
              return sb.txns - sa.txns || sb.users - sa.users;
            case "popular":
            default:
              return (sb.users * PERSON_WEIGHT + sb.txns) - (sa.users * PERSON_WEIGHT + sa.txns);
          }
        });
        return sorted;
      }

      function renderDapps(dapps) {
        if (!list) return;
        clearList();

        if (!Array.isArray(dapps) || dapps.length === 0) {
          addRow("(no dapps configured)");
          return;
        }

        const sorted = sortApps(dapps);

        for (const dapp of sorted) {
          const li = document.createElement("li");

          const link = document.createElement("a");
          link.className = "dappLink";
          link.href = dapp.url;
          link.target = "_blank";
          link.rel = "noopener";

          const nameRow = document.createElement("div");
          nameRow.className = "nameRow";

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = dapp.name || "(unnamed)";
          nameRow.appendChild(name);

          if (dapp.pubkey) {
            const s = statsMap[dapp.pubkey];
            const statsEl = document.createElement("div");
            statsEl.className = "stats";

            if (s) {
              const userStat = document.createElement("span");
              userStat.className = "stat";
              userStat.appendChild(personIcon());
              userStat.appendChild(document.createTextNode(formatNum(s.users)));

              const txStat = document.createElement("span");
              txStat.className = "stat";
              txStat.appendChild(txIcon());
              txStat.appendChild(document.createTextNode(formatNum(s.txns)));

              statsEl.appendChild(userStat);
              statsEl.appendChild(txStat);
            } else {
              const loading = document.createElement("span");
              loading.className = "statsLoading";
              loading.textContent = "loading...";
              statsEl.appendChild(loading);
            }

            nameRow.appendChild(statsEl);
          }

          const author = document.createElement("div");
          author.className = "author";
          author.textContent = `by ${dapp.author || "unknown"}`;

          const url = document.createElement("div");
          url.className = "url";
          url.innerHTML = `<span class="urlText">${dapp.url || ""}</span>`;

          link.appendChild(nameRow);
          link.appendChild(author);
          link.appendChild(url);
          li.appendChild(link);
          list.appendChild(li);
        }
      }

      async function loadDappsJson() {
        const resp = await fetch("./dapps.json", { cache: "no-store" });
        if (!resp.ok) {
          throw new Error(`Failed to load dapps.json: HTTP ${resp.status}`);
        }
        return await resp.json();
      }

      async function explorerFetch(path, opts) {
        const resp = await fetch(`${EXPLORER_BASE}${path}`, opts);
        if (!resp.ok) throw new Error(`Explorer ${resp.status}`);
        return resp.json();
      }

      async function discoverChainId() {
        const data = await explorerFetch("/active_chain");
        return data.chain_id;
      }

      async function fetchStatsForPubkey(chainId, pubkey) {
        const senders = new Set();
        let totalTxns = 0;
        let cursor = null;
        const MAX_PAGES = 20;

        for (let page = 0; page < MAX_PAGES; page++) {
          const body = { recipient: pubkey, limit: 50 };
          if (cursor) body.cursor = cursor;
          const data = await explorerFetch(`/${chainId}/transactions`, {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(body),
          });
          const items = data.items || [];
          for (const tx of items) {
            const sender = tx.source || tx.from_pubkey || tx.from;
            if (sender) senders.add(sender);
            totalTxns++;
          }
          if (!data.has_more || !data.next_cursor) break;
          cursor = data.next_cursor;
        }
        return { users: senders.size, txns: totalTxns };
      }

      async function loadAllStats(apps) {
        let chainId;
        try {
          chainId = await discoverChainId();
        } catch (e) {
          console.warn("Could not discover chain ID:", e);
          return;
        }

        const pubkeys = apps.filter((a) => a.pubkey).map((a) => a.pubkey);
        const fetches = pubkeys.map(async (pk) => {
          try {
            const stats = await fetchStatsForPubkey(chainId, pk);
            statsMap[pk] = stats;
            renderDapps(allApps);
          } catch (e) {
            console.warn(`Stats fetch failed for ${pk.slice(0, 16)}â€¦:`, e);
          }
        });
        await Promise.all(fetches);
      }

      // --- Sort menu ---
      function updateSortUI() {
        sortLabel.textContent = SORT_LABELS[currentSort] || "Popular";
        sortMenu.querySelectorAll(".sortOpt").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.sort === currentSort);
        });
      }

      sortBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        sortMenu.classList.toggle("open");
      });

      sortMenu.addEventListener("click", (e) => {
        const opt = e.target.closest(".sortOpt");
        if (!opt) return;
        currentSort = opt.dataset.sort;
        localStorage.setItem(SORT_KEY, currentSort);
        updateSortUI();
        renderDapps(allApps);
        sortMenu.classList.remove("open");
      });

      document.addEventListener("click", () => {
        sortMenu.classList.remove("open");
      });

      updateSortUI();

      (async function main() {
        addRow("(loading dapps...)");
        try {
          const json = await loadDappsJson();
          allApps = Array.isArray(json) ? json : json.apps || json.items || [];
          renderDapps(allApps);
          loadAllStats(allApps);
        } catch (e) {
          clearList();
          addRow(
            `(error loading dapps.json: ${e && e.message ? e.message : String(e)})`
          );
        }
      })();

      // --- Rubber-band (overscroll-like) stretch config ---
      const RUBBER_BAND = {
        deadzonePx: 6,
        maxPullPx: 92,
        constant: 0.56,
        snapMs: 210,
        snapEasing: "cubic-bezier(0.2, 0.9, 0.2, 1)",
        enableScaleY: true,
        scaleDivisor: 850,
      };

      function rubberBandDistance(d, dimension, constant) {
        const abs = Math.abs(d);
        if (dimension <= 0) return 0;
        const result = (constant * abs * dimension) / (dimension + constant * abs);
        return Math.sign(d) * result;
      }

      (function attachRubberBand() {
        const listEl = document.getElementById("dappList");
        if (!listEl) return;

        let startY = 0;
        let activePointerId = null;
        let dragging = false;
        let moved = false;

        function apply(offset) {
          const t = offset;
          if (RUBBER_BAND.enableScaleY) {
            const s = 1 + Math.abs(offset) / RUBBER_BAND.scaleDivisor;
            listEl.style.transform = `translateY(${t}px) scaleY(${s})`;
          } else {
            listEl.style.transform = `translateY(${t}px)`;
          }
        }

        function reset() {
          listEl.style.transition = `transform ${RUBBER_BAND.snapMs}ms ${RUBBER_BAND.snapEasing}`;
          listEl.style.transform = "";
          window.setTimeout(() => {
            listEl.style.transition = "";
          }, RUBBER_BAND.snapMs + 40);
        }

        listEl.addEventListener("pointerdown", (e) => {
          if (e.button != null && e.button !== 0) return;
          activePointerId = e.pointerId;
          startY = e.clientY;
          dragging = true;
          moved = false;
          listEl.style.transition = "";
          e.preventDefault();
          try {
            listEl.setPointerCapture(activePointerId);
          } catch (_) {}
        });

        listEl.addEventListener(
          "pointermove",
          (e) => {
            if (!dragging || e.pointerId !== activePointerId) return;
            const dy = e.clientY - startY;

            if (Math.abs(dy) > RUBBER_BAND.deadzonePx) moved = true;
            const effectiveDy =
              Math.abs(dy) <= RUBBER_BAND.deadzonePx
                ? 0
                : dy - Math.sign(dy) * RUBBER_BAND.deadzonePx;

            const dim = window.innerHeight || 800;
            let offset = rubberBandDistance(
              effectiveDy,
              dim,
              RUBBER_BAND.constant
            );

            const max = RUBBER_BAND.maxPullPx;
            if (offset > max) offset = max;
            if (offset < -max) offset = -max;

            apply(offset);
            e.preventDefault();
          },
          { passive: false }
        );

        function end(e) {
          if (!dragging || e.pointerId !== activePointerId) return;
          dragging = false;
          activePointerId = null;
          reset();
        }

        listEl.addEventListener("pointerup", end);
        listEl.addEventListener("pointercancel", end);

        listEl.addEventListener(
          "click",
          (e) => {
            if (!moved) return;
            e.preventDefault();
            e.stopPropagation();
            moved = false;
          },
          true
        );
      })();

    </script>
  </body>
</html>
